#
# Simplified Dockerfile using agent-cli
# No build stage needed - just install the published npm package
#

# Use pre-built runtime as base
ARG RUNTIME_VERSION=latest
FROM deepracticexs/agent-runtime:${RUNTIME_VERSION}

# Switch to root for installations
USER root

WORKDIR /app

# Install agent-cli globally (will be published to npm)
# For now, we copy the local build
COPY apps/agent-cli/package.json apps/agent-cli/dist ./temp-cli/
WORKDIR /app/temp-cli
RUN npm install -g .

# Install Claude Code CLI
RUN npm install -g @anthropic-ai/claude-code

# Cleanup temp directory
WORKDIR /app
RUN rm -rf temp-cli

# Environment variables
ENV NODE_ENV=production \
    PORT=5200 \
    PROJECT_PATH=/project \
    HOME=/home/node

# Runtime variables (must be provided):
# - ANTHROPIC_API_KEY (required)
# - ANTHROPIC_BASE_URL (optional)

# Create project directory
RUN mkdir -p /project && chown node:node /project

# Switch to non-root user
USER node

# Expose port
EXPOSE 5200

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:5200/health || exit 1

# Start application using agent-cli
CMD ["agent-cli", "http", "--host", "0.0.0.0", "--port", "5200"]
